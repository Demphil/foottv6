name: Update Matches Data

on:
  schedule:
    - cron: '0 */3 * * *'  # ÙƒÙ„ 3 Ø³Ø§Ø¹Ø§Øª (Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† 6)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-matches:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Prepare Environment
        run: |
          mkdir -p assets/data
          npm install axios cheerio --no-package-lock --no-save

      - name: Run Scraper
        env:
          SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
        run: |
          cat << 'EOF' > scrape.js
          const axios = require('axios');
          const cheerio = require('cheerio');
          const fs = require('fs');
          const path = require('path');

          const BASE_URL = 'https://www.kooora.com';
          const TARGET_URLS = [
            `${BASE_URL}/?show=matchs`,    # Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
            `${BASE_URL}/?show=matchs&d=1` # Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ØºØ¯
          ];

          async function scrapeMatches() {
            try {
              let allMatches = [];
              
              for (const url of TARGET_URLS) {
                const apiUrl = `https://api.scraperapi.com/?api_key=${process.env.SCRAPER_API_KEY}&url=${encodeURIComponent(url)}&render=true`;
                
                console.log(`Fetching data from: ${url}`);
                const response = await axios.get(apiUrl, {
                  timeout: 30000,
                  headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36'
                  }
                });

                const $ = cheerio.load(response.data);
                const matches = [];

                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
                $('.match-item, .match-card').each((i, element) => {
                  const match = $(element);
                  const leagueElement = match.closest('.league-section');
                  
                  const homeTeam = {
                    name: match.find('.home-team, .team-home').text().trim() || 'ÙØ±ÙŠÙ‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    logo: match.find('.home-team img, .team-home img').attr('src') || ''
                  };

                  const awayTeam = {
                    name: match.find('.away-team, .team-away').text().trim() || 'ÙØ±ÙŠÙ‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                    logo: match.find('.away-team img, .team-away img').attr('src') || ''
                  };

                  const league = {
                    name: leagueElement.find('.league-name').text().trim() || 'Ø¨Ø·ÙˆÙ„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©',
                    logo: leagueElement.find('img').attr('src') || ''
                  };

                  const channels = [];
                  match.find('.channels img, .broadcasters img').each((i, el) => {
                    channels.push($(el).attr('alt') || $(el).attr('title') || 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©');
                  });

                  matches.push({
                    id: match.attr('id') || `match-${Date.now()}-${i}`,
                    homeTeam,
                    awayTeam,
                    score: match.find('.sc, .score').text().trim() || 'VS',
                    time: match.find('.match-time, .time').text().trim() || '--:--',
                    date: new Date().toISOString(),
                    league,
                    channels: channels.length ? channels : ['ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'],
                    status: match.hasClass('live') ? 'Ù…Ø¨Ø§Ø´Ø±' : 
                           match.hasClass('finished') ? 'Ù…Ù†ØªÙ‡ÙŠ' : 'Ù‚Ø§Ø¯Ù…'
                  });
                });

                allMatches = [...allMatches, ...matches];
              }

              // ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„ØºØ¯
              const today = new Date().toISOString().split('T')[0];
              const result = {
                today: allMatches.filter(m => m.date.includes(today)),
                tomorrow: allMatches.filter(m => !m.date.includes(today)),
                updatedAt: new Date().toISOString()
              };

              fs.writeFileSync('assets/data/matches.json', JSON.stringify(result, null, 2));
              console.log(`âœ… ØªÙ… Ø­ÙØ¸ ${allMatches.length} Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­`);

            } catch (error) {
              console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error.message);
              createFallbackData();
            }
          }

          function createFallbackData() {
            const fallbackData = {
              today: [
                {
                  id: 'fallback-1',
                  homeTeam: { name: 'Ø§Ù„Ù‡Ù„Ø§Ù„', logo: '' },
                  awayTeam: { name: 'Ø§Ù„Ù†ØµØ±', logo: '' },
                  score: 'VS',
                  time: '21:00',
                  date: new Date().toISOString(),
                  league: { name: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ', logo: '' },
                  channels: ['bein SPORTS HD1'],
                  status: 'Ù‚Ø§Ø¯Ù…'
                }
              ],
              tomorrow: [],
              updatedAt: new Date().toISOString()
            };

            if (!fs.existsSync('assets/data')) {
              fs.mkdirSync('assets/data', { recursive: true });
            }
            
            fs.writeFileSync('assets/data/matches.json', JSON.stringify(fallbackData, null, 2));
            console.log('ğŸ”„ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
          }

          scrapeMatches();
          EOF

          node scrape.js

      - name: Verify Data
        run: |
          echo "ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:"
          echo "Ø¹Ø¯Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…: $(jq '.today | length' assets/data/matches.json)"
          echo "Ø¹Ø¯Ø¯ Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø§Ù„ØºØ¯: $(jq '.tomorrow | length' assets/data/matches.json)"
          echo "Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: $(jq -r '.updatedAt' assets/data/matches.json)"

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add assets/data/matches.json
          git diff --cached --quiet || (git commit -m "ğŸ”„ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª [skip ci]" && git push)
