name: Update Matches Data

on:
  schedule:
    - cron: '0 */6 * * *'  # ÙƒÙ„ 6 Ø³Ø§Ø¹Ø§Øª
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-matches:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Initialize Project
        run: |
          mkdir -p assets/data
          echo '{"private":true}' > package.json

      - name: Install Dependencies
        run: npm install axios cheerio --no-package-lock --no-save

      - name: Fetch and Process Matches
        env:
          SCRAPER_API_KEY: ${{ secrets.SCRAPER_API_KEY }}
        run: |
          node -e "
          const axios = require('axios');
          const cheerio = require('cheerio');
          const fs = require('fs');
          const path = require('path');

          async function scrapeLiveScore() {
            try {
              const targetUrl = 'https://www.livescore.com/';
              const apiUrl = `https://api.scraperapi.com/?api_key=${process.env.SCRAPER_API_KEY}&url=${encodeURIComponent(targetUrl)}`;
              
              const response = await axios.get(apiUrl);
              const $ = cheerio.load(response.data);
              
              const matches = [];
              const IMPORTANT_LEAGUES = ['Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ', 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠ', 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ', 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠ', 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ'];
              
              // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ù…Ù† Ø§Ù„ØµÙØ­Ø©
              $('.match').each((i, element) => {
                const match = $(element);
                const leagueName = match.closest('.league')?.find('.name')?.text()?.trim();
                
                if (!IMPORTANT_LEAGUES.some(league => leagueName.includes(league))) {
                  return;
                }
                
                const homeTeam = {
                  name: match.find('.home .name')?.text()?.trim() || 'ÙØ±ÙŠÙ‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                  logo: match.find('.home .logo')?.attr('src') || ''
                };
                
                const awayTeam = {
                  name: match.find('.away .name')?.text()?.trim() || 'ÙØ±ÙŠÙ‚ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                  logo: match.find('.away .logo')?.attr('src') || ''
                };
                
                matches.push({
                  id: match.attr('data-id') || Date.now().toString(),
                  homeTeam,
                  awayTeam,
                  score: match.find('.score')?.text()?.trim() || 'vs',
                  time: match.find('.time')?.text()?.trim() || 'Ø§Ù„Ø¢Ù†',
                  date: new Date().toISOString(),
                  league: {
                    id: generateLeagueId(leagueName),
                    name: leagueName || 'Ø¨Ø·ÙˆÙ„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©'
                  },
                  venue: match.find('.venue')?.text()?.trim() || 'Ù…Ù„Ø¹Ø¨ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                  broadcast: extractBroadcastInfo(match)
                });
              });
              
              // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
              const outputPath = path.join('assets', 'data', 'matches.json');
              fs.writeFileSync(outputPath, JSON.stringify(matches, null, 2));
              console.log('âœ… ØªÙ… Ø­ÙØ¸', matches.length, 'Ù…Ø¨Ø§Ø±Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­');
              
            } catch (error) {
              console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error.message);
              createFallbackData();
            }
          }
          
          function generateLeagueId(leagueName) {
            const leagueMap = {
              'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ': 564,
              'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ': 39,
              'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠ': 140,
              'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠ': 78,
              'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥ÙŠØ·Ø§Ù„ÙŠ': 135,
              'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„ÙØ±Ù†Ø³ÙŠ': 61
            };
            
            return leagueMap[leagueName] || Math.floor(Math.random() * 1000);
          }
          
          function extractBroadcastInfo(match) {
            const broadcastText = match.find('.broadcast')?.text()?.trim();
            if (!broadcastText) return [];
            
            return broadcastText.split(',').map(channel => ({
              name: channel.trim()
            }));
          }
          
          function createFallbackData() {
            const fallbackMatches = [
              {
                id: 'fallback-1',
                homeTeam: { name: 'Ø§Ù„Ù‡Ù„Ø§Ù„', logo: '' },
                awayTeam: { name: 'Ø§Ù„Ù†ØµØ±', logo: '' },
                score: 'vs',
                time: '21:00',
                date: new Date().toISOString(),
                league: { id: 564, name: 'Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ' },
                venue: 'Ù…Ù„Ø¹Ø¨ Ø§Ù„Ù…Ù„Ùƒ ÙÙ‡Ø¯',
                broadcast: [{ name: 'bein SPORTS HD1' }],
                manualChannels: ['bein SPORTS HD1']
              }
            ];
            
            const outputPath = path.join('assets', 'data', 'matches.json');
            fs.writeFileSync(outputPath, JSON.stringify(fallbackMatches, null, 2));
            console.log('âš ï¸ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
          }
          
          scrapeLiveScore();
          "

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Bot"
          git config --global user.email "actions@users.noreply.github.com"
          git add assets/data/matches.json
          git diff --cached --quiet || git commit -m "ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø±ÙŠØ§Øª Ø¹Ø¨Ø± ScraperAPI"
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }} HEAD:main
